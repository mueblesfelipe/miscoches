<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <title>Mis Coches</title>
    <style>
        :root { --primary: #2563eb; --secondary: #64748b; --bg: #f1f5f9; --white: #ffffff; --danger: #ef4444; --success: #22c55e; --warning: #f59e0b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #1e293b; font-size: 14px; min-height: 100vh; position: relative; padding-bottom: 50px; }
        .container { max-width: 800px; margin: auto; }
        .view { display: none; }
        .view.active { display: block; }
        
        /* PANTALLA BIENVENIDA */
        #splash { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--primary); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; color: white; transition: opacity 0.6s ease; text-align: center; }
        #splash h1 { font-size: 2.8rem; margin-bottom: 5px; letter-spacing: -1px; }
        #splash .signature-splash { font-size: 0.9rem; opacity: 0.9; font-weight: 300; margin-top: 10px; }
        .loader { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-bottom-color: #FFF; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; margin: 20px 0; }
        
        /* FIRMA FIJA EN APP */
        .signature-fixed { position: fixed; bottom: 12px; right: 12px; font-size: 10px; color: var(--secondary); opacity: 0.6; pointer-events: none; z-index: 1000; font-weight: 600; }

        /* ESTILOS DE LA APP */
        #garaje-lista { display: grid; grid-template-columns: repeat(auto-fill, minmax(175px, 1fr)); gap: 12px; }
        .card { background: var(--white); border-radius: 12px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; position: relative; }
        .card-img { width: 100%; height: 115px; object-fit: cover; background: #cbd5e1; cursor: pointer; display: block; }
        .card-content { padding: 8px; cursor: pointer; }
        .card-content strong { font-size: 14px; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .info-tag { display: block; font-size: 10px; font-weight: bold; padding: 4px; border-radius: 5px; margin-top: 5px; text-align: center; }
        .tag-ok { background: #dcfce7; color: #166534; }
        .tag-alert { background: #fee2e2; color: #991b1b; animation: pulse 2s infinite; }
        .tag-mantenimiento { background: #fef3c7; color: #92400e; border: 1px dashed #f59e0b; }
        .btn-historial { display: block; background: var(--secondary); color: white; text-align: center; font-size: 11px; font-weight: bold; padding: 7px; border-radius: 6px; margin-top: 6px; cursor: pointer; }
        .section-box { background: #f8fafc; padding: 12px; border-radius: 10px; border: 1px solid #e2e8f0; margin-bottom: 15px; }
        .grid-checks { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; background: white; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .check-item { display: flex; align-items: center; gap: 6px; font-size: 11px; }
        .btn { padding: 12px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; width: 100%; font-size: 14px; margin-top: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .historial-item { background: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--primary); position: relative; }
        .historial-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 12px; }
        .chips { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 5px; }
        .chip { background: #e2e8f0; font-size: 9px; padding: 2px 6px; border-radius: 10px; font-weight: bold; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="splash">
        <h1>Mis Coches</h1>
        <div class="signature-splash">Creado por Felipe Ledo Ramos</div>
        <span class="loader"></span>
        <p style="font-size: 0.8rem; opacity: 0.8;">Cargando garaje...</p>
    </div>

    <div class="signature-fixed">Felipe Ledo Ramos</div>

    <div class="container">
        <div id="view-list" class="view active">
            <h1 style="display:flex; justify-content:space-between; align-items:center;">Mis Coches <button class="btn btn-primary" onclick="showForm(-1)" style="width:auto; margin:0; padding:5px 15px;">+</button></h1>
            <button id="btn-notif" class="btn" style="background:#fef3c7; color:#92400e; font-size:12px; display:none;" onclick="requestNotif()">üîî Activar Alertas</button>
            <div id="garaje-lista"></div>
            <div style="margin-top:30px; border-top:1px solid #ccc; padding-top:10px; padding-bottom:20px;">
                <button class="btn" style="background:#ddd; font-size:11px;" onclick="exportData()">Exportar Copia (.json)</button>
                <button class="btn" style="background:#ddd; font-size:11px;" onclick="document.getElementById('importInput').click()">Importar Copia</button>
                <input type="file" id="importInput" style="display:none" onchange="importData(this)">
            </div>
        </div>

        <div id="view-form" class="view">
            <h2>Datos del Veh√≠culo</h2>
            <div class="field">
                <label>Foto del coche</label>
                <img id="preview-img" style="width:100%; height:180px; object-fit:cover; border-radius:8px; display:none; margin-bottom:10px; border:1px solid #ccc;">
                <input type="file" accept="image/*" onchange="processImage(this)">
                <input type="hidden" id="foto-base64">
            </div>
            <div style="display:flex; gap:8px;">
                <div class="field" style="flex:2"><label>Marca/Modelo</label><input type="text" id="marca"></div>
                <div class="field" style="flex:1"><label>Matr√≠cula</label><input type="text" id="matricula"></div>
            </div>
            <div class="section-box">
                <label>PLANIFICACI√ìN</label>
                <select id="intervalo_a√±os"><option value="1">Cada 1 A√±o</option><option value="2">Cada 2 A√±os</option><option value="5">Cada 5 A√±os</option></select>
                <div style="display:flex; gap:8px; margin-top:10px;">
                    <div style="flex:1"><label>Pr√≥xima ITV</label><input type="date" id="itv"></div>
                    <div style="flex:1"><label>Pr√≥x. Rev.</label><input type="date" id="mantenimiento"></div>
                </div>
            </div>
            <div class="section-box">
                <label>SEGURO</label>
                <input type="text" id="seguro_cia" placeholder="Compa√±√≠a" style="margin-bottom:8px;">
                <div style="display:flex; gap:8px;">
                    <input type="tel" id="seguro_tel" placeholder="Tel. Asistencia" style="flex:1">
                    <input type="date" id="seguro_vencimiento" style="flex:1">
                </div>
            </div>
            <button class="btn btn-primary" onclick="saveCoche()">Guardar</button>
            <button class="btn" onclick="showView('view-list')">Cancelar</button>
            <button class="btn" style="color:red; background:none; font-size:11px;" onclick="deleteCoche()">Eliminar</button>
        </div>

        <div id="view-historial" class="view">
            <h2 id="historial-title">Historial</h2>
            <div id="lista-mantenimientos"></div>
            <hr>
            <h3 id="mant-form-title">Nuevo Registro</h3>
            <input type="hidden" id="edit-mant-index">
            <div style="display:flex; gap:8px;">
                <div class="field" style="flex:1"><label>Fecha</label><input type="date" id="mant-fecha"></div>
                <div class="field" style="flex:1"><label>Kms</label><input type="number" id="mant-kms"></div>
            </div>
            <div class="grid-checks">
                <div class="check-item"><input type="checkbox" class="filtro" value="Aceite"> Aceite</div>
                <div class="check-item"><input type="checkbox" class="filtro" value="F. Aceite"> F. Aceite</div>
                <div class="check-item"><input type="checkbox" class="filtro" value="F. Aire"> F. Aire</div>
                <div class="check-item"><input type="checkbox" class="filtro" value="Liq. Frenos"> Liq. Frenos</div>
                <div class="check-item"><input type="checkbox" class="filtro" value="Correa Dist."> Correa Dist.</div>
                <div class="check-item"><input type="checkbox" class="filtro" value="Aceite Caja"> Aceite Caja</div>
            </div>
            <div class="field" style="margin-top:10px;"><label>Otro:</label><input type="text" id="mant-otro"></div>
            <textarea id="mant-notas" placeholder="Notas adicionales..." rows="2" style="width:100%; border-radius:8px; border:1px solid #cbd5e1; padding:10px;"></textarea>
            <button class="btn btn-primary" onclick="saveMantenimiento()">Guardar Registro</button>
            <button class="btn" onclick="cancelMantEdit()" id="btn-cancel-mant" style="display:none;">Cancelar</button>
            <button class="btn" onclick="showView('view-list')">Cerrar</button>
        </div>
    </div>

<script>
    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }

    window.onload = () => {
        setTimeout(() => {
            const splash = document.getElementById('splash');
            splash.style.opacity = '0';
            setTimeout(() => splash.style.display = 'none', 600);
        }, 2500);
    };

    let coches = [];
    let currentCocheIdx = -1;

    function loadData() {
        coches = JSON.parse(localStorage.getItem('misCoches')) || [];
        renderList();
        if (Notification.permission !== "granted") document.getElementById('btn-notif').style.display = "block";
        checkAlerts();
    }

    function processImage(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 600;
                let width = img.width;
                let height = img.height;
                if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                canvas.width = width; canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                document.getElementById('foto-base64').value = dataUrl;
                document.getElementById('preview-img').src = dataUrl;
                document.getElementById('preview-img').style.display = 'block';
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function renderList() {
        const lista = document.getElementById('garaje-lista');
        lista.innerHTML = '';
        const hoy = new Date().setHours(0,0,0,0);
        coches.forEach((c, i) => {
            const itvA = c.itv && new Date(c.itv) < hoy ? 'tag-alert' : 'tag-ok';
            const segA = c.seguro_vencimiento && new Date(c.seguro_vencimiento) < hoy ? 'tag-alert' : 'tag-ok';
            const mantA = c.mantenimiento && new Date(c.mantenimiento) < hoy ? 'tag-alert' : 'tag-mantenimiento';
            lista.innerHTML += `
                <div class="card">
                    <img src="${c['foto-base64'] || 'https://via.placeholder.com/300x150?text=Sin+Foto'}" class="card-img" onclick="showForm(${i})">
                    <div class="card-content" onclick="showForm(${i})">
                        <strong>${c.marca}</strong>
                        <div class="info-tag ${itvA}">ITV: ${fmt(c.itv)}</div>
                        <div class="info-tag ${segA}">Seguro: ${fmt(c.seguro_vencimiento)}</div>
                        <div class="info-tag ${mantA}">Rev: ${fmt(c.mantenimiento)}</div>
                    </div>
                    <div style="padding:0 8px 8px;">
                        <div class="btn-historial" onclick="showHistorial(${i})">üìã HISTORIAL</div>
                    </div>
                </div>`;
        });
    }

    function saveCoche() {
        const c = {
            marca: document.getElementById('marca').value,
            matricula: document.getElementById('matricula').value,
            itv: document.getElementById('itv').value,
            mantenimiento: document.getElementById('mantenimiento').value,
            intervalo_a√±os: document.getElementById('intervalo_a√±os').value,
            seguro_cia: document.getElementById('seguro_cia').value,
            seguro_tel: document.getElementById('seguro_tel').value,
            seguro_vencimiento: document.getElementById('seguro_vencimiento').value,
            'foto-base64': document.getElementById('foto-base64').value
        };
        if(!c.marca) return alert("Por favor, pon la marca");
        if(currentCocheIdx >= 0) { c.historial = coches[currentCocheIdx].historial; coches[currentCocheIdx] = c; }
        else { c.historial = []; coches.push(c); }
        localStorage.setItem('misCoches', JSON.stringify(coches));
        showView('view-list'); renderList();
    }

    function showForm(idx) {
        currentCocheIdx = idx;
        const fields = ['marca','matricula','itv','mantenimiento','seguro_cia','seguro_tel','seguro_vencimiento','foto-base64','intervalo_a√±os'];
        fields.forEach(f => {
            const el = document.getElementById(f);
            if(el) el.value = (f === 'intervalo_a√±os' ? "1" : "");
        });
        document.getElementById('preview-img').style.display = 'none';
        if(idx >= 0) {
            const c = coches[idx];
            fields.forEach(f => { if(c[f]) document.getElementById(f).value = c[f]; });
            if(c['foto-base64']) {
                document.getElementById('preview-img').src = c['foto-base64'];
                document.getElementById('preview-img').style.display = 'block';
            }
        }
        showView('view-form');
    }

    function showHistorial(idx) {
        currentCocheIdx = idx;
        document.getElementById('historial-title').innerText = "Historial: " + coches[idx].marca;
        cancelMantEdit(); renderMantenimientos(); showView('view-historial');
    }

    function saveMantenimiento() {
        const fecha = document.getElementById('mant-fecha').value;
        if(!fecha) return alert("Fecha obligatoria");
        const items = Array.from(document.querySelectorAll('.filtro:checked')).map(cb => cb.value);
        const otro = document.getElementById('mant-otro').value.trim();
        if(otro) items.push(otro);
        const m = { fecha, kms: document.getElementById('mant-kms').value, notas: document.getElementById('mant-notas').value, items };
        const editIdx = document.getElementById('edit-mant-index').value;
        if(editIdx === "") {
            coches[currentCocheIdx].historial.unshift(m);
            let nf = new Date(fecha);
            nf.setFullYear(nf.getFullYear() + parseInt(coches[currentCocheIdx].intervalo_a√±os || 1));
            coches[currentCocheIdx].mantenimiento = nf.toISOString().split('T')[0];
        } else {
            coches[currentCocheIdx].historial[editIdx] = m;
        }
        localStorage.setItem('misCoches', JSON.stringify(coches));
        cancelMantEdit(); renderMantenimientos(); renderList();
    }

    function renderMantenimientos() {
        const div = document.getElementById('lista-mantenimientos');
        div.innerHTML = '';
        (coches[currentCocheIdx].historial || []).forEach((m, i) => {
            div.innerHTML += `
                <div class="historial-item">
                    <div class="historial-actions"><span onclick="editMantenimiento(${i})">‚úèÔ∏è</span><span onclick="deleteMantenimiento(${i})">üóëÔ∏è</span></div>
                    <strong>${fmt(m.fecha)} - ${m.kms} km</strong>
                    <div class="chips">${m.items.map(it => `<span class="chip">${it}</span>`).join('')}</div>
                </div>`;
        });
    }

    function editMantenimiento(i) {
        const m = coches[currentCocheIdx].historial[i];
        document.getElementById('edit-mant-index').value = i;
        document.getElementById('mant-fecha').value = m.fecha;
        document.getElementById('mant-kms').value = m.kms;
        document.getElementById('mant-notas').value = m.notas;
        document.querySelectorAll('.filtro').forEach(cb => cb.checked = m.items.includes(cb.value));
        document.getElementById('mant-form-title').innerText = "Editar Registro";
        document.getElementById('btn-cancel-mant').style.display = "block";
    }

    function deleteMantenimiento(i) { if(confirm("¬øBorrar registro?")) { coches[currentCocheIdx].historial.splice(i,1); localStorage.setItem('misCoches', JSON.stringify(coches)); renderMantenimientos(); } }
    function cancelMantEdit() { 
        document.getElementById('edit-mant-index').value = ""; 
        document.getElementById('mant-fecha').value = new Date().toISOString().split('T')[0];
        document.querySelectorAll('.filtro').forEach(cb => cb.checked = false);
        document.getElementById('btn-cancel-mant').style.display = "none";
        document.getElementById('mant-form-title').innerText = "Nuevo Registro";
    }

    function checkAlerts() {
        const hoy = new Date();
        coches.forEach(c => {
            const itv = new Date(c.itv) - hoy;
            if (c.itv && itv > 0 && itv < 2592000000) sendNotif(`ITV: ${c.marca}`, "Queda menos de un mes para la ITV.");
        });
    }

    function sendNotif(tit, body) {
        if (Notification.permission === "granted") {
            navigator.serviceWorker.ready.then(reg => reg.showNotification(tit, { body, icon: "https://cdn-icons-png.flaticon.com/512/741/741407.png" }));
        }
    }
    function requestNotif() { Notification.requestPermission().then(() => document.getElementById('btn-notif').style.display="none"); }
    function fmt(f) { if(!f) return '--/--/--'; const p = f.split('-'); return `${p[2]}/${p[1]}/${p[0]}`; }
    function showView(v) { document.querySelectorAll('.view').forEach(x => x.classList.remove('active')); document.getElementById(v).classList.add('active'); window.scrollTo(0,0); }
    function exportData() { 
        const blob = new Blob([JSON.stringify(coches)], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `mis_coches_backup.json`; a.click(); 
    }
    function importData(input) {
        const r = new FileReader(); r.onload = e => { try { coches = JSON.parse(e.target.result); localStorage.setItem('misCoches', JSON.stringify(coches)); renderList(); alert("Datos importados"); } catch(e){alert("Error al importar");} };
        r.readAsText(input.files[0]);
    }
    function deleteCoche() { if(confirm("¬øEliminar este coche definitivamente?")) { coches.splice(currentCocheIdx, 1); localStorage.setItem('misCoches', JSON.stringify(coches)); showView('view-list'); renderList(); } }

    loadData();
</script>
</body>
</html>