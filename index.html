<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <title>Mis Coches</title>
    <style>
        :root { --primary: #2563eb; --secondary: #64748b; --bg: #f1f5f9; --white: #ffffff; --danger: #ef4444; --success: #22c55e; --warning: #f59e0b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #1e293b; font-size: 14px; min-height: 100vh; padding-bottom: 40px; box-sizing: border-box; }
        .container { max-width: 800px; margin: auto; }
        .view { display: none; }
        .view.active { display: block; }
        
        /* PANTALLA AZUL DE INICIO */
        #splash { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--primary); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; color: white; transition: opacity 0.6s ease; text-align: center; }
        #splash h1 { font-size: 2.5rem; margin-bottom: 0; }
        #splash p { font-size: 1rem; opacity: 0.9; margin-top: 5px; font-weight: 300; }
        .loader { width: 35px; height: 35px; border: 4px solid rgba(255,255,255,0.3); border-bottom-color: #FFF; border-radius: 50%; animation: rotation 1s linear infinite; margin: 20px 0; }
        
        .signature-fixed { position: fixed; bottom: 8px; right: 8px; font-size: 9px; color: var(--secondary); opacity: 0.5; z-index: 1000; font-weight: 600; }

        /* TARJETAS Y LISTADO */
        #garaje-lista { display: grid; grid-template-columns: repeat(auto-fill, minmax(155px, 1fr)); gap: 10px; }
        .card { background: var(--white); border-radius: 10px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; display: flex; flex-direction: column; }
        .card-img { width: 100%; height: 90px; object-fit: cover; background: #cbd5e1; cursor: pointer; }
        .card-content { padding: 6px 8px; cursor: pointer; }
        .card-content strong { font-size: 13px; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .info-tag { display: block; font-size: 9px; font-weight: bold; padding: 3px; border-radius: 4px; margin-top: 3px; text-align: center; }
        .tag-ok { background: #dcfce7; color: #166534; }
        .tag-alert { background: #fee2e2; color: #991b1b; animation: pulse 2s infinite; }
        .tag-mantenimiento { background: #fef3c7; color: #92400e; border: 1px dashed #f59e0b; }
        
        .card-actions { padding: 6px; display: flex; flex-direction: column; gap: 4px; }
        .btn-card { font-size: 10px; font-weight: bold; padding: 6px; border-radius: 5px; text-align: center; text-decoration: none; color: white; cursor: pointer; }
        .btn-hist { background: var(--secondary); }
        .btn-asis { background: var(--success); }

        .section-box { background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 12px; }
        .field { margin-bottom: 8px; }
        .field label { display: block; font-size: 10px; font-weight: bold; color: var(--secondary); margin-bottom: 2px; }
        input, select, textarea { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #cbd5e1; font-size: 14px; box-sizing: border-box; }
        
        .grid-checks { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 10px 0; }
        .check-item { display: flex; align-items: center; gap: 5px; font-size: 11px; font-weight: 600; background: white; padding: 5px; border-radius: 5px; border: 1px solid #e2e8f0; }
        .check-item input { width: auto; }

        .btn { padding: 10px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; width: 100%; font-size: 14px; margin-top: 6px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }

        .historial-item { background: white; padding: 8px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid var(--primary); position: relative; }
        .chips { display: flex; flex-wrap: wrap; gap: 3px; margin-top: 5px; }
        .chip { background: #e2e8f0; font-size: 9px; padding: 2px 5px; border-radius: 4px; font-weight: bold; color: #475569; }

        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="splash">
        <h1>Mis Coches</h1>
        <p>Creado por Felipe Ledo Ramos</p>
        <span class="loader"></span>
    </div>

    <div class="signature-fixed">Felipe Ledo Ramos</div>

    <div class="container">
        <div id="view-list" class="view active">
            <h2 style="display:flex; justify-content:space-between; align-items:center;">Mis Coches <button class="btn btn-primary" onclick="showForm(-1)" style="width:auto; margin:0; padding:4px 12px;">+</button></h2>
            
            <div id="garaje-lista"></div>
            
            <div style="margin-top:20px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn" style="background:#e2e8f0; font-size:10px;" onclick="exportData()">Exportar JSON</button>
                <button class="btn" style="background:#e2e8f0; font-size:10px;" onclick="document.getElementById('importInput').click()">Importar JSON</button>
                <input type="file" id="importInput" style="display:none" onchange="importData(this)">
            </div>
            
            <button class="btn btn-danger" style="margin-top:20px; opacity:0.8;" onclick="closeApp()">Cerrar Aplicaci√≥n</button>
        </div>

        <div id="view-form" class="view">
            <h3>Datos Veh√≠culo</h3>
            <div id="form-container">
                <div class="field">
                    <img id="preview-img" style="width:100%; height:150px; object-fit:cover; border-radius:8px; display:none; border:1px solid #ccc; margin-bottom:5px;">
                    <input type="file" id="file-input" accept="image/*" onchange="processImage(this)" style="font-size: 11px;">
                    <input type="hidden" id="foto-base64">
                    <button id="btn-del-img" class="btn" style="display:none; background:var(--danger); font-size:10px; padding:4px;" onclick="removePhoto()">Eliminar Foto</button>
                </div>
                <div style="display:flex; gap:6px;">
                    <div class="field" style="flex:2"><label>Marca/Modelo</label><input type="text" id="marca"></div>
                    <div class="field" style="flex:1"><label>Matr√≠cula</label><input type="text" id="matricula"></div>
                </div>
                <div class="field"><label>VIN (Bastidor)</label><input type="text" id="vin" style="text-transform: uppercase;"></div>
                <div class="section-box">
                    <div style="display:flex; gap:6px;">
                        <div style="flex:1" class="field"><label>Pr√≥x. ITV</label><input type="date" id="itv"></div>
                        <div style="flex:1" class="field"><label>Pr√≥x. Rev.</label><input type="date" id="mantenimiento"></div>
                    </div>
                    <label style="font-size:10px;">Intervalo a√±os:</label><input type="number" id="intervalo_a√±os" value="1">
                </div>
                <div class="section-box">
                    <label style="font-size:10px; font-weight:bold;">SEGURO</label>
                    <input type="text" id="seguro_cia" placeholder="Compa√±√≠a">
                    <input type="tel" id="seguro_tel" placeholder="Tel. Asistencia" style="margin-top:5px;">
                    <input type="date" id="seguro_vencimiento" style="margin-top:5px;">
                </div>
                <button class="btn btn-primary" onclick="saveCoche()">Guardar</button>
                <button class="btn" onclick="showView('view-list')" style="background:#cbd5e1;">Volver</button>
            </div>
        </div>

        <div id="view-historial" class="view">
            <h3 id="historial-title">Historial</h3>
            <div id="lista-mantenimientos"></div>
            <div class="section-box" id="form-registro">
                <h4 id="mant-form-title">A√±adir Registro</h4>
                <input type="hidden" id="edit-mant-index" value="">
                <div style="display:flex; gap:6px;">
                    <input type="date" id="mant-fecha" style="flex:1">
                    <input type="number" id="mant-kms" placeholder="Kms" style="flex:1">
                </div>
                <div class="grid-checks">
                    <label class="check-item"><input type="checkbox" class="mant-check" value="Aceite"> Aceite</label>
                    <label class="check-item"><input type="checkbox" class="mant-check" value="F. Aceite"> F. Aceite</label>
                    <label class="check-item"><input type="checkbox" class="mant-check" value="F. Polen"> F. Polen</label>
                    <label class="check-item"><input type="checkbox" class="mant-check" value="F. Aire"> F. Aire</label>
                    <label class="check-item"><input type="checkbox" class="mant-check" value="F. Combust."> F. Combust.</label>
                    <label class="check-item"><input type="checkbox" class="mant-check" value="L√≠q. Frenos"> L√≠q. Frenos</label>
                    <label class="check-item"><input type="checkbox" class="mant-check" value="Buj√≠as"> Buj√≠as</label>
                    <label class="check-item"><input type="checkbox" class="mant-check" value="Aceite Cambio"> Aceite Cambio</label>
                    <label class="check-item" style="grid-column: span 2;"><input type="checkbox" class="mant-check" value="Kit Distribuci√≥n"> Kit Distribuci√≥n</label>
                </div>
                <textarea id="mant-notas" placeholder="Otras anotaciones..." rows="2"></textarea>
                <button class="btn btn-primary" onclick="saveMantenimiento()">Guardar</button>
                <button class="btn" id="btn-cancel-mant" style="display:none; background:#cbd5e1;" onclick="resetMantForm()">Cancelar</button>
            </div>
            <button class="btn" onclick="showView('view-list')" style="background:#cbd5e1;">Cerrar</button>
        </div>
    </div>

<script>
    let coches = [];
    let currentCocheIdx = -1;

    window.onload = () => {
        setTimeout(() => { document.getElementById('splash').style.opacity = '0'; 
        setTimeout(() => document.getElementById('splash').style.display = 'none', 600); }, 2000);
        loadData();
    };

    function closeApp() {
        if(confirm("¬øDeseas cerrar la aplicaci√≥n?")) {
            window.close();
            // Fallback para navegadores que bloquean window.close()
            alert("Para cerrar, simplemente cierra la pesta√±a de tu navegador.");
        }
    }

    // Funciones de carga, imagen y renderizado (se mantienen igual que la versi√≥n anterior)
    function loadData() { coches = JSON.parse(localStorage.getItem('misCoches')) || []; renderList(); }
    
    function processImage(input) {
        const file = input.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 500;
                let width = img.width, height = img.height;
                if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                canvas.width = width; canvas.height = height;
                canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.5);
                document.getElementById('foto-base64').value = dataUrl;
                document.getElementById('preview-img').src = dataUrl;
                document.getElementById('preview-img').style.display = 'block';
                document.getElementById('btn-del-img').style.display = 'block';
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function removePhoto() {
        document.getElementById('foto-base64').value = "";
        document.getElementById('preview-img').style.display = 'none';
        document.getElementById('btn-del-img').style.display = 'none';
        document.getElementById('file-input').value = "";
    }

    function renderList() {
        const lista = document.getElementById('garaje-lista');
        lista.innerHTML = '';
        const hoy = new Date().setHours(0,0,0,0);
        coches.forEach((c, i) => {
            const itvA = c.itv && new Date(c.itv) < hoy ? 'tag-alert' : 'tag-ok';
            const segA = c.seguro_vencimiento && new Date(c.seguro_vencimiento) < hoy ? 'tag-alert' : 'tag-ok';
            const mantA = c.mantenimiento && new Date(c.mantenimiento) < hoy ? 'tag-alert' : 'tag-mantenimiento';
            lista.innerHTML += `
                <div class="card">
                    <img src="${c['foto-base64'] || 'https://via.placeholder.com/300x150?text=Sin+Foto'}" class="card-img" onclick="showForm(${i})">
                    <div class="card-content" onclick="showForm(${i})">
                        <strong>${c.marca}</strong>
                        <div class="info-tag ${itvA}">ITV: ${fmt(c.itv)}</div>
                        <div class="info-tag ${segA}">Seg: ${fmt(c.seguro_vencimiento)}</div>
                        <div class="info-tag ${mantA}">Rev: ${fmt(c.mantenimiento)}</div>
                    </div>
                    <div class="card-actions">
                        <div class="btn-card btn-hist" onclick="showHistorial(${i})">üìã HISTORIAL</div>
                        ${c.seguro_tel ? `<a href="tel:${c.seguro_tel}" class="btn-card btn-asis">üìû ASISTENCIA</a>` : ''}
                    </div>
                </div>`;
        });
    }

    function saveCoche() {
        const c = {
            marca: document.getElementById('marca').value,
            matricula: document.getElementById('matricula').value,
            vin: document.getElementById('vin').value,
            itv: document.getElementById('itv').value,
            mantenimiento: document.getElementById('mantenimiento').value,
            intervalo_a√±os: document.getElementById('intervalo_a√±os').value,
            seguro_cia: document.getElementById('seguro_cia').value,
            seguro_tel: document.getElementById('seguro_tel').value,
            seguro_vencimiento: document.getElementById('seguro_vencimiento').value,
            'foto-base64': document.getElementById('foto-base64').value,
            historial: (currentCocheIdx >= 0) ? (coches[currentCocheIdx].historial || []) : []
        };
        if(!c.marca) return alert("Indica la marca");
        if(currentCocheIdx >= 0) coches[currentCocheIdx] = c; else coches.push(c);
        localStorage.setItem('misCoches', JSON.stringify(coches));
        showView('view-list'); renderList();
    }

    function showForm(idx) {
        currentCocheIdx = idx;
        const fields = ['marca','matricula','vin','itv','mantenimiento','seguro_cia','seguro_tel','seguro_vencimiento','foto-base64','intervalo_a√±os'];
        fields.forEach(f => { if(document.getElementById(f)) document.getElementById(f).value = (f === 'intervalo_a√±os' ? "1" : ""); });
        removePhoto();
        if(idx >= 0) {
            const c = coches[idx];
            fields.forEach(f => { if(c[f] && document.getElementById(f)) document.getElementById(f).value = c[f]; });
            if(c['foto-base64']) { document.getElementById('preview-img').src = c['foto-base64']; document.getElementById('preview-img').style.display = 'block'; document.getElementById('btn-del-img').style.display = 'block'; }
        }
        showView('view-form');
    }

    function showHistorial(idx) { currentCocheIdx = idx; document.getElementById('historial-title').innerText = "Historial: " + coches[idx].marca; resetMantForm(); renderMantenimientos(); showView('view-historial'); }

    function saveMantenimiento() {
        const fecha = document.getElementById('mant-fecha').value;
        if(!fecha) return alert("Fecha obligatoria");
        const checks = Array.from(document.querySelectorAll('.mant-check:checked')).map(c => c.value);
        const m = { fecha, kms: document.getElementById('mant-kms').value, notas: document.getElementById('mant-notas').value, items: checks };
        const editIdx = document.getElementById('edit-mant-index').value;
        if(!coches[currentCocheIdx].historial) coches[currentCocheIdx].historial = [];
        if(editIdx === "") { 
            coches[currentCocheIdx].historial.unshift(m); 
            let nf = new Date(fecha); nf.setFullYear(nf.getFullYear() + parseInt(coches[currentCocheIdx].intervalo_a√±os || 1));
            coches[currentCocheIdx].mantenimiento = nf.toISOString().split('T')[0];
        } else { coches[currentCocheIdx].historial[editIdx] = m; }
        localStorage.setItem('misCoches', JSON.stringify(coches));
        resetMantForm(); renderMantenimientos(); renderList();
    }

    function renderMantenimientos() {
        const div = document.getElementById('lista-mantenimientos');
        div.innerHTML = '';
        (coches[currentCocheIdx].historial || []).forEach((m, i) => {
            const chips = (m.items || []).map(it => `<span class="chip">${it}</span>`).join('');
            div.innerHTML += `<div class="historial-item">
                <div style="position:absolute; top:5px; right:5px;">
                    <span onclick="editMantenimiento(${i})">‚úèÔ∏è</span>
                    <span onclick="deleteMantenimiento(${i})" style="margin-left:10px;">üóëÔ∏è</span>
                </div>
                <strong>${fmt(m.fecha)} - ${m.kms || 0} km</strong><div class="chips">${chips}</div>
                <p style="margin:4px 0 0; color:#475569; font-size:11px;">${m.notas || ''}</p>
            </div>`;
        });
    }

    function editMantenimiento(i) {
        const m = coches[currentCocheIdx].historial[i];
        document.getElementById('edit-mant-index').value = i;
        document.getElementById('mant-fecha').value = m.fecha;
        document.getElementById('mant-kms').value = m.kms;
        document.getElementById('mant-notas').value = m.notas;
        document.querySelectorAll('.mant-check').forEach(cb => cb.checked = (m.items || []).includes(cb.value));
        document.getElementById('mant-form-title').innerText = "Editando Registro";
        document.getElementById('btn-cancel-mant').style.display = "block";
    }

    function deleteMantenimiento(i) { if(confirm("¬øBorrar?")) { coches[currentCocheIdx].historial.splice(i, 1); localStorage.setItem('misCoches', JSON.stringify(coches)); renderMantenimientos(); } }
    function resetMantForm() { document.getElementById('edit-mant-index').value = ""; document.getElementById('mant-fecha').value = new Date().toISOString().split('T')[0]; document.getElementById('mant-kms').value = ""; document.getElementById('mant-notas').value = ""; document.querySelectorAll('.mant-check').forEach(cb => cb.checked = false); document.getElementById('mant-form-title').innerText = "A√±adir Registro"; document.getElementById('btn-cancel-mant').style.display = "none"; }
    function fmt(f) { if(!f) return '--/--/--'; const p = f.split('-'); return `${p[2]}/${p[1]}/${p[0].substring(2)}`; }
    function showView(v) { document.querySelectorAll('.view').forEach(x => x.classList.remove('active')); document.getElementById(v).classList.add('active'); window.scrollTo(0,0); }
    function exportData() { const blob = new Blob([JSON.stringify(coches)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `mis_coches.json`; a.click(); }
    function importData(input) { const r = new FileReader(); r.onload = e => { try { const data = JSON.parse(e.target.result); if(Array.isArray(data)) { coches = data; localStorage.setItem('misCoches', JSON.stringify(coches)); renderList(); } } catch(e){ alert("Error"); } }; r.readAsText(input.files[0]); }
    function deleteCoche() { if(confirm("¬øEliminar coche?")) { coches.splice(currentCocheIdx, 1); localStorage.setItem('misCoches', JSON.stringify(coches)); showView('view-list'); renderList(); } }
</script>
</body>
</html>
